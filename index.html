<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel & CSV Random Comment Picker</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .confetti-piece {
            position: absolute; width: 8px; height: 16px; background: #3b82f6; top: 0; opacity: 0;
            animation: confetti-fall 3s ease-out forwards;
        }
        @keyframes confetti-fall {
            0% { transform: translateY(-10vh) rotateZ(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotateZ(720deg); opacity: 0; }
        }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-box { transition: transform 0.3s ease, opacity 0.3s ease; }
        #slot-machine-text { transition: transform 0.1s ease-out; }
        .summary-item { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 text-gray-800">

    <div class="w-full max-w-5xl mx-auto">
        <main id="mainGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div id="settingsPanel" class="bg-white rounded-2xl shadow-lg p-6 md:p-8 relative">
                <div class="mb-6">
                    <h1 class="text-3xl font-extrabold text-gray-800">Giveaway Picker Pro</h1>
                </div>
                <div class="absolute top-6 right-6">
                    <label for="dataFile" title="Unggah File Komentar" class="cursor-pointer text-gray-500 hover:text-indigo-600 p-2 rounded-full transition-colors">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    </label>
                    <input type="file" id="dataFile" class="hidden" accept=".csv,.xlsx,.xls">
                </div>
                <div class="space-y-5">
                    <div>
                        <label for="postLink" class="block text-sm font-semibold text-gray-700 mb-2">1. Link Postingan</label>
                        <input type="text" id="postLink" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500" placeholder="https://www.instagram.com/p/...">
                    </div>
                    <div>
                        <label for="mentionCount" class="block text-sm font-semibold text-gray-700 mb-2">2. Minimal Mention Teman</label>
                        <input type="number" id="mentionCount" value="3" min="0" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500" placeholder="Contoh: 3">
                    </div>
                    <div>
                        <label for="winnerCount" class="block text-sm font-semibold text-gray-700 mb-2">3. Jumlah Pemenang</label>
                        <input type="number" id="winnerCount" value="1" min="1" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500">
                    </div>
                     <div class="pt-2">
                        <span id="fileName" class="text-sm text-gray-500">File belum dipilih. Klik ikon upload.</span>
                    </div>
                </div>
                <div class="mt-8 flex flex-col sm:flex-row gap-3">
                    <button id="pickButton" class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200 transform hover:scale-105 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
                        Mulai Undian
                    </button>
                    <button id="resetButton" class="w-full sm:w-auto bg-gray-200 text-gray-700 font-bold py-3 px-6 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                        Reset
                    </button>
                </div>
            </div>
            <div id="results-panel" class="bg-white rounded-2xl shadow-lg p-6 md:p-8 flex flex-col items-center justify-center min-h-[400px] relative overflow-hidden">
                <div id="confetti-container"></div>
                <div id="messageBox" class="w-full"></div>
                <div id="initial-state" class="text-center">
                     <svg class="mx-auto h-24 w-24 text-indigo-200" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M15.5 2H8.6c-.4 0-.8.2-1.1.5-.3.3-.5.7-.5 1.1v12.8c0 .4.2.8.5 1.1.3.3.7.5 1.1.5h9.8c.4 0 .8-.2 1.1-.5.3-.3.5-.7.5-1.1V6.5L15.5 2z"/><path d="M3 7.6v12.8c0 .4.2.8.5 1.1.3.3.7.5 1.1.5h9.8"/><path d="M15 2v5h5"/><path d="M8 18h1"/><path d="M12 18h5"/><path d="M10 14h1"/><path d="M14 14h5"/></svg>
                    <h3 class="mt-4 text-lg font-semibold text-gray-700">Pemenang Akan Muncul di Sini</h3>
                    <p class="mt-1 text-sm text-gray-500">Isi data di samping dan mulai undian.</p>
                </div>
                <div id="drawing-state" class="hidden text-center w-full">
                    <h3 class="text-xl font-semibold text-gray-500 mb-4">Mengundi Pemenang...</h3>
                    <div class="h-24 bg-gray-100 rounded-lg flex items-center justify-center overflow-hidden">
                        <p id="slot-machine-text" class="text-3xl font-bold text-indigo-600"></p>
                    </div>
                </div>
                <div id="summary-container" class="w-full hidden"></div>
            </div>
        </main>
    </div>
    <div id="winnerModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none"></div>
    
    <script>
        // --- GLOBAL STATE ---
        let allParticipants = [];
        let drawnWinners = [];
        let remainingParticipants = [];
        let totalWinnerCount = 0;
        let currentWinnerIndex = 0;

        // --- DOM Element Selection ---
        const postLinkInput = document.getElementById("postLink");
        const mentionCountInput = document.getElementById("mentionCount");
        const dataFileInput = document.getElementById("dataFile");
        const fileNameSpan = document.getElementById("fileName");
        const winnerCountInput = document.getElementById("winnerCount");
        const pickButton = document.getElementById("pickButton");
        const resetButton = document.getElementById("resetButton");
        const messageBox = document.getElementById("messageBox");
        const initialState = document.getElementById("initial-state");
        const drawingState = document.getElementById("drawing-state");
        const summaryContainer = document.getElementById("summary-container");
        const slotMachineText = document.getElementById("slot-machine-text");
        const confettiContainer = document.getElementById("confetti-container");
        const winnerModal = document.getElementById("winnerModal");

        // --- Event Listeners ---
        pickButton.addEventListener("click", startGiveaway);
        resetButton.addEventListener("click", resetApp);

        dataFileInput.addEventListener("change", () => {
            const file = dataFileInput.files[0];
            if (file) {
                fileNameSpan.textContent = `Data komentar berhasil dimuat.`;
                fileNameSpan.classList.add("text-green-600", "font-semibold");
            } else {
                fileNameSpan.textContent = "File belum dipilih. Klik ikon upload di pojok kanan atas.";
                fileNameSpan.classList.remove("text-green-600", "font-semibold");
            }
        });

        winnerModal.addEventListener("click", function(event) {
            const targetId = event.target.id;
            if (targetId === 'modalCloseBtn') closeModal();
            if (targetId === 'modalGoToCommentBtn') goToComment(event.target.dataset.commentId);
            if (targetId === 'modalNextBtn') viewNextWinner();
            if (targetId === 'modalRepickBtn') repickWinner();
        });

        function startGiveaway() {
            messageBox.innerHTML = "";
            summaryContainer.classList.add("hidden");
            
            const file = dataFileInput.files[0]; // Correctly define file here
            if (!file) {
                return displayMessage("error", "Silakan unggah file terlebih dahulu.");
            }
            
            totalWinnerCount = parseInt(winnerCountInput.value, 10);
            if (isNaN(totalWinnerCount) || totalWinnerCount < 1) {
                return displayMessage("error", "Jumlah pemenang harus diisi dengan angka (minimal 1).");
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const data = event.target.result;
                    if (file.name.endsWith(".csv")) {
                        allParticipants = parseAndFilter(data, parseCsv);
                    } else if (file.name.endsWith(".xlsx") || file.name.endsWith(".xls")) {
                        allParticipants = parseAndFilter(data, parseExcel);
                    } else {
                        throw new Error("Format file tidak didukung. Gunakan .csv, .xlsx, atau .xls");
                    }

                    if (allParticipants.length < totalWinnerCount) {
                        return displayMessage("warning", `Hanya ada ${allParticipants.length} peserta yang memenuhi syarat, tidak cukup untuk memilih ${totalWinnerCount} pemenang.`);
                    }

                    pickButton.disabled = true;
                    pickButton.classList.add("opacity-50", "cursor-not-allowed");
                    
                    const shuffled = shuffleArray([...allParticipants]);
                    drawnWinners = shuffled.slice(0, totalWinnerCount);
                    remainingParticipants = shuffled.slice(totalWinnerCount);
                    currentWinnerIndex = 0;

                    runDrawingAnimation(() => {
                        displayWinnerInModal(drawnWinners[currentWinnerIndex]);
                        pickButton.disabled = false;
                        pickButton.classList.remove("opacity-50", "cursor-not-allowed");
                    });
                } catch (e) {
                    displayMessage("error", e.message);
                }
            };
            
            if (file.name.endsWith(".csv")) {
                 reader.readAsText(file);
            } else {
                 reader.readAsArrayBuffer(file);
            }
        }

        function parseAndFilter(data, parserFn) {
            const parsedData = parserFn(data);
            const minMentions = parseInt(mentionCountInput.value, 10) || 0;
            const uniqueUsers = new Map();

            parsedData.forEach(user => {
                if (typeof user !== 'object' || user === null) return;

                const username = user.username ? String(user.username).trim() : null;
                const comment = user.komentar ? String(user.komentar).trim() : null;
                const comment_id = user.comment_id ? String(user.comment_id).trim() : null;
                const profile_pic_url = user.profile_pic_url ? String(user.profile_pic_url).trim() : null;
                
                if (!username || !comment || uniqueUsers.has(username)) return;

                const mentionCount = (comment.match(/@/g) || []).length;
                
                if (mentionCount >= minMentions) {
                    uniqueUsers.set(username, { username, comment, profile_pic_url, comment_id });
                }
            });
            
            const finalParticipants = Array.from(uniqueUsers.values());
            
            if (finalParticipants.length === 0) {
                displayMessage("error", "Tidak ada komentar yang memenuhi syarat mention.");
            }
            return finalParticipants;
        }

        function viewNextWinner() {
            closeModal();
            currentWinnerIndex++;
            runDrawingAnimation(() => {
                displayWinnerInModal(drawnWinners[currentWinnerIndex]);
            }, 2000);
        }
        
        function repickWinner() {
            if (remainingParticipants.length === 0) {
                return alert("Tidak ada peserta lain yang tersisa untuk dipilih ulang.");
            }
            closeModal();
            const newWinner = remainingParticipants.shift();
            drawnWinners[currentWinnerIndex] = newWinner;
            runDrawingAnimation(() => {
                displayWinnerInModal(newWinner);
            }, 3000);
        }

        function runDrawingAnimation(callback, duration = 4000) {
            initialState.classList.add("hidden");
            drawingState.classList.remove("hidden");
            let animationInterval = setInterval(() => {
                const randomIndex = Math.floor(Math.random() * allParticipants.length);
                slotMachineText.textContent = allParticipants[randomIndex].username;
            }, 100);
            setTimeout(() => {
                clearInterval(animationInterval);
                drawingState.classList.add("hidden");
                if (callback) {
                    callback();
                }
            }, duration);
        }

        function displayWinnerInModal(winnerData) {
            const { username, comment, profile_pic_url, comment_id } = winnerData;
            const fallbackAvatar = `https://ui-avatars.com/api/?name=${username.charAt(0)}&background=random&color=fff&size=96&bold=true`;
            const showNextBtn = currentWinnerIndex < totalWinnerCount - 1;
            const showRepickBtn = remainingParticipants.length > 0;

            const modalContent = `
                <div class="modal-box bg-white w-full max-w-md rounded-2xl shadow-xl p-6 text-center transform scale-95 opacity-0">
                    <div class="flex justify-between items-center mb-4">
                         <h2 class="text-xl font-bold text-gray-800">Pemenang #${currentWinnerIndex + 1}</h2>
                         <button id="modalCloseBtn" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                    </div>
                    <img src="/.netlify/functions/fetch-image?url=${encodeURIComponent(profile_pic_url || "")}" onerror="this.onerror=null;this.src='${fallbackAvatar}';" class="w-24 h-24 rounded-full mx-auto border-4 border-white shadow-lg bg-gray-200" alt="Avatar Pemenang">
                    <h3 class="text-2xl font-bold text-indigo-600 mt-4">${username}</h3>
                    <p class="text-gray-600 mt-2 px-4 h-20 overflow-y-auto text-sm">"${comment}"</p>
                    <div class="mt-6 grid grid-cols-2 gap-3">
                        <button id="modalGoToCommentBtn" data-comment-id="${comment_id || ""}" class="w-full bg-purple-500 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-purple-600 transition-colors">Lihat Komentar</button>
                        <a href="https://www.instagram.com/${username}/" target="_blank" rel="noopener noreferrer" class="w-full bg-blue-500 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center">Lihat Profil</a>
                    </div>
                    <div class="mt-3 grid ${showNextBtn && showRepickBtn ? "grid-cols-2" : "grid-cols-1"} gap-3">
                         ${showRepickBtn ? `<button id="modalRepickBtn" class="w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600 transition-colors">Ganti Pemenang</button>` : ""}
                         ${showNextBtn ? `<button id="modalNextBtn" class="w-full bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-600 transition-colors">Pemenang Berikutnya</button>` : ""}
                    </div>
                </div>
            `;
            winnerModal.innerHTML = modalContent;
            openModal();
        }

        function displayWinnerSummary() {
            initialState.classList.add("hidden");
            drawingState.classList.add("hidden");
            summaryContainer.classList.remove("hidden");

            let html = `
                <div class="flex justify-between items-center w-full mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">üèÜ Rekap Pemenang üèÜ</h2>
                    <button id="downloadBtn" class="bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Download
                    </button>
                </div>
            `;
            html += '<div class="space-y-3 max-h-[350px] overflow-y-auto pr-2">';
            
            drawnWinners.forEach((winner, index) => {
                const fallbackAvatar = `https://ui-avatars.com/api/?name=${winner.username.charAt(0)}&background=random&color=fff&size=40&bold=true`;
                html += `
                    <div class="summary-item flex items-center bg-gray-50 p-3 rounded-lg border border-gray-200" style="opacity:0; animation-delay: ${index * 100}ms;">
                        <span class="flex items-center justify-center h-8 w-8 rounded-full bg-gray-200 text-gray-700 font-bold mr-3">${index + 1}</span>
                        <img src="/.netlify/functions/fetch-image?url=${encodeURIComponent(winner.profile_pic_url || "")}" onerror="this.onerror=null;this.src='${fallbackAvatar}';" class="w-10 h-10 rounded-full mr-3 bg-gray-200">
                        <div class="flex-grow">
                             <a href="https://www.instagram.com/${winner.username}/" target="_blank" rel="noopener noreferrer" class="font-semibold text-indigo-600 hover:underline">
                                ${winner.username}
                            </a>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            summaryContainer.innerHTML = html;
            document.getElementById("downloadBtn").addEventListener("click", downloadSummaryAsDoc);
        }

        function downloadSummaryAsDoc() {
            let content = `
                <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                <head><meta charset='utf-8'><title>Rekap Pemenang Giveaway</title></head>
                <body>
                    <h1>Rekap Pemenang Giveaway</h1>
                    <p><strong>Link Postingan:</strong> <a href="${postLinkInput.value}">${postLinkInput.value || "Tidak dicantumkan"}</a></p>
                    <table border="1" style="width:100%; border-collapse: collapse; font-family: sans-serif;">
                        <thead>
                            <tr style="background-color: #f2f2f2;">
                                <th style="padding: 8px; text-align: left;">No.</th>
                                <th style="padding: 8px; text-align: left;">Username</th>
                                <th style="padding: 8px; text-align: left;">Komentar</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            drawnWinners.forEach((winner, index) => {
                content += `
                    <tr>
                        <td style="padding: 8px; text-align: center;">${index + 1}</td>
                        <td style="padding: 8px;"><a href="https://www.instagram.com/${winner.username}/">${winner.username}</a></td>
                        <td style="padding: 8px;">${winner.comment}</td>
                    </tr>
                `;
            });
            content += `
                        </tbody>
                    </table>
                </body>
                </html>
            `;
            const blob = new Blob(["\ufeff", content], { type: "application/msword" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = "rekap-pemenang.doc";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function goToComment(commentId) {
            const link = postLinkInput.value;
            if (!link) return alert("Link postingan belum dimasukkan.");
            if (!commentId) return window.open(link, "_blank");
            const shortcodeMatch = link.match(/\/p\/([a-zA-Z0-9_-]+)/);
            if (shortcodeMatch && shortcodeMatch[1]) {
                window.open(`https://www.instagram.com/p/${shortcodeMatch[1]}/c/${commentId}/`, "_blank");
            } else {
                alert("Format link postingan tidak valid.");
            }
        }

        function openModal() {
            winnerModal.classList.remove("opacity-0", "pointer-events-none");
            setTimeout(() => {
                winnerModal.querySelector(".modal-box").classList.remove("scale-95", "opacity-0");
            }, 10);
            triggerConfetti();
        }

        function closeModal() {
            if (winnerModal.querySelector(".modal-box")) {
                winnerModal.querySelector(".modal-box").classList.add("scale-95", "opacity-0");
                setTimeout(() => {
                    winnerModal.classList.add("opacity-0", "pointer-events-none");
                    if (drawnWinners.length > 0 && currentWinnerIndex >= totalWinnerCount - 1) {
                        displayWinnerSummary();
                    }
                }, 300);
            }
        }

        function parseExcel(data) {
            const workbook = XLSX.read(data, { type: "array" });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            return XLSX.utils.sheet_to_json(worksheet, { defval: "" });
        }

        function parseCsv(csvText) {
            const lines = csvText.trim().split("\n");
            if (lines.length < 2) return [];
            const header = lines[0].split(",").map(h => h.trim().toLowerCase().replace(/"/g, ""));
            const dataRows = lines.slice(1);
            return dataRows.map(line => {
                const parts = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                let row = {};
                header.forEach((col, index) => {
                    row[col] = (parts[index] || "").trim().replace(/"/g, "");
                });
                return row;
            });
        }

        function resetApp() {
            document.getElementById("postLink").value = "";
            document.getElementById("mentionCount").value = "3";
            dataFileInput.value = "";
            fileNameSpan.textContent = "File belum dipilih. Klik ikon upload di pojok kanan atas.";
            fileNameSpan.classList.remove("text-green-600", "font-semibold");
            winnerCountInput.value = "1";
            messageBox.innerHTML = "";
            initialState.classList.remove("hidden");
            drawingState.classList.add("hidden");
            summaryContainer.classList.add("hidden");
            confettiContainer.innerHTML = "";
            allParticipants = [];
            drawnWinners = [];
            remainingParticipants = [];
            currentWinnerIndex = 0;
            totalWinnerCount = 0;
            closeModal();
        }

        function displayMessage(type, message) {
            initialState.classList.add("hidden");
            let bgColor, textColor, borderColor;
            if (type === "error") {
                [bgColor, textColor, borderColor] = ["bg-red-100", "text-red-800", "border-red-400"];
            } else {
                [bgColor, textColor, borderColor] = ["bg-yellow-100", "text-yellow-800", "border-yellow-400"];
            }
            messageBox.innerHTML = `<div class="${bgColor} border-l-4 ${borderColor} ${textColor} p-4 rounded-lg" role="alert"><p class="font-semibold">${message}</p></div>`;
            drawingState.classList.add("hidden");
            setTimeout(() => {
                messageBox.innerHTML = "";
                initialState.classList.remove("hidden");
            }, 5000);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function triggerConfetti() {
            confettiContainer.innerHTML = "";
            for (let i = 0; i < 100; i++) {
                const confettiPiece = document.createElement("div");
                confettiPiece.className = "confetti-piece";
                confettiPiece.style.left = `${Math.random() * 100}%`;
                confettiPiece.style.animationDelay = `${Math.random() * 3}s`;
                confettiPiece.style.backgroundColor = `hsl(${210 + Math.random() * 40}, 100%, 60%)`;
                confettiContainer.appendChild(confettiPiece);
            }
        }
    </script>
</body>
</html>
